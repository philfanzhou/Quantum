using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Linq;
using System.Net;
using System.IO;
using System.Text;
using System.Collections.Generic;
using System.Diagnostics;
using Quantum.Infrastructure.MarketData.Repository;
using Quantum.Domain.MarketData;

namespace Quantum.MarketData.Test
{
    [TestClass]
    public class IntradayInfoTest
    {

        [TestMethod]
        public void TestRealTimeDataToIntradayData()
        {
            List<string> dataSource = GetSourceDate().ToList();

            List<RealTimeData> realTimeDataList = new List<RealTimeData>();
            foreach(string str in dataSource)
            {
                SinaRealTimeData data = new SinaRealTimeData(str);
                realTimeDataList.Add(data);
            }

            IntradayInfo info = new IntradayInfo();
            foreach(var item in realTimeDataList)
            {
                info.AddRealTimeData(item);
            }

            Assert.IsTrue(info.Items.Count() == 5);

            IntradayData _1300 = info.Items.ToList()[2];
            Assert.IsTrue(_1300.Time.Minute == 0);
            Assert.IsTrue(_1300.Price == 16.18);
            Assert.IsTrue(_1300.AveragePrice == 16.26);
            Assert.IsTrue(_1300.Change == 0.02);
            Assert.IsTrue(_1300.ChangeRate == 0.12);
            Assert.IsTrue(_1300.IntradayVolume == 390744);
            Assert.IsTrue(_1300.IntradayAmount == 6327356);

            IntradayData _1301 = info.Items.ToList()[3];
            Assert.IsTrue(_1301.Time.Minute == 1);
            Assert.IsTrue(_1301.Price == 16.24);
            Assert.IsTrue(_1301.AveragePrice == 16.26);
            Assert.IsTrue(_1301.Change == 0.08);
            Assert.IsTrue(_1301.ChangeRate == 0.50);
            Assert.IsTrue(_1301.IntradayVolume == 176704);
            Assert.IsTrue(_1301.IntradayAmount == 2861000);

            IntradayData _1302 = info.Items.ToList()[4];
            Assert.IsTrue(_1302.Time.Minute == 2);
            Assert.IsTrue(_1302.Price == 16.18);
            Assert.IsTrue(_1302.AveragePrice == 16.26);
            Assert.IsTrue(_1302.Change == 0.02);
            Assert.IsTrue(_1302.ChangeRate == 0.12);
            Assert.IsTrue(_1302.IntradayVolume == 126729);
            Assert.IsTrue(_1302.IntradayAmount == 2056903);
        }

        private IEnumerable<string> GetSourceDate()
        {
            List<string> strList = new List<string>();
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.20,16.22,33483129,544403720,9122,16.20,262715,16.19,15700,16.18,9100,16.17,122100,16.16,6500,16.22,10500,16.23,41900,16.24,81000,16.25,46900,16.26,2015-09-08,11:35:50,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.20,16.22,33483129,544403720,9122,16.20,262715,16.19,15700,16.18,9100,16.17,122100,16.16,6500,16.22,10500,16.23,41900,16.24,81000,16.25,46900,16.26,2015-09-08,12:59:50,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.20,16.22,33483129,544403720,9122,16.20,262715,16.19,15700,16.18,9100,16.17,122100,16.16,6500,16.22,10500,16.23,41900,16.24,81000,16.25,46900,16.26,2015-09-08,12:59:55,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.20,16.22,33483129,544403720,9122,16.20,262715,16.19,15700,16.18,9100,16.17,122100,16.16,6500,16.22,10500,16.23,41900,16.24,81000,16.25,46900,16.26,2015-09-08,13:00:00,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.19,16.20,33697851,547881168,127215,16.19,19000,16.18,7700,16.17,127500,16.16,37629,16.15,43204,16.20,400,16.21,16100,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:05,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.19,16.40,16.05,16.19,16.20,33711051,548094922,122115,16.19,19000,16.18,7200,16.17,127400,16.16,37129,16.15,50604,16.20,400,16.21,16700,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:10,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.19,16.20,33715151,548161342,119015,16.19,18200,16.18,7200,16.17,127400,16.16,37129,16.15,46604,16.20,400,16.21,20300,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:15,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.19,16.20,33715151,548161342,119015,16.19,18200,16.18,7200,16.17,127400,16.16,37129,16.15,46604,16.20,400,16.21,20300,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:20,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.19,16.20,33723751,548300662,119015,16.19,18200,16.18,7200,16.17,127400,16.16,37129,16.15,63904,16.20,400,16.21,20300,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:25,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.19,16.40,16.05,16.19,16.20,33842073,550216396,10793,16.19,18200,16.18,7200,16.17,127400,16.16,37129,16.15,54404,16.20,400,16.21,20300,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:30,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.19,16.40,16.05,16.19,16.20,33851173,550363725,3693,16.19,18200,16.18,7200,16.17,127400,16.16,37129,16.15,54404,16.20,400,16.21,21100,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:35,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.19,16.20,33858073,550475404,2300,16.19,14993,16.18,7200,16.17,127400,16.16,37129,16.15,55404,16.20,400,16.21,21100,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:40,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.19,16.20,33858073,550475404,2800,16.19,14993,16.18,7200,16.17,127400,16.16,37129,16.15,55404,16.20,400,16.21,21100,16.22,10400,16.23,41700,16.24,2015-09-08,13:00:46,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.18,16.19,33871873,550698716,3993,16.18,27200,16.17,127400,16.16,37129,16.15,5400,16.14,31600,16.19,57204,16.20,400,16.21,21100,16.22,10400,16.23,2015-09-08,13:00:51,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.18,16.19,33873873,550731076,1993,16.18,27200,16.17,127400,16.16,37129,16.15,5400,16.14,33900,16.19,57204,16.20,400,16.21,21100,16.22,10400,16.23,2015-09-08,13:00:56,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.18,16.19,33873873,550731076,1993,16.18,27200,16.17,127400,16.16,37129,16.15,5400,16.14,35600,16.19,50304,16.20,400,16.21,21100,16.22,10400,16.23,2015-09-08,13:01:01,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.18,16.19,33874973,550748875,993,16.18,27200,16.17,127400,16.16,37129,16.15,5400,16.14,29400,16.19,50304,16.20,400,16.21,21100,16.22,10400,16.23,2015-09-08,13:01:06,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.17,16.40,16.05,16.17,16.18,33886373,550933223,16793,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,5300,16.18,19000,16.19,50304,16.20,400,16.21,21100,16.22,2015-09-08,13:01:11,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.17,16.18,33891473,551015721,14793,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,15300,16.18,19000,16.19,49304,16.20,400,16.21,21100,16.22,2015-09-08,13:01:16,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.17,16.18,33906573,551260039,14793,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,20400,16.18,19000,16.19,49304,16.20,400,16.21,17500,16.22,2015-09-08,13:01:21,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.17,16.40,16.05,16.17,16.18,33910573,551324722,32093,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,20100,16.18,19000,16.19,49304,16.20,400,16.21,17500,16.22,2015-09-08,13:01:26,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.17,16.18,33913773,551376478,30093,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,19300,16.18,12100,16.19,50804,16.20,400,16.21,17500,16.22,2015-09-08,13:01:31,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.17,16.40,16.05,16.17,16.18,33929373,551628880,29493,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,11200,16.18,12100,16.19,50804,16.20,400,16.21,17500,16.22,2015-09-08,13:01:36,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.17,16.18,33931273,551659622,29993,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,9300,16.18,4000,16.19,53604,16.20,400,16.21,17500,16.22,2015-09-08,13:01:41,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.19,16.40,16.05,16.17,16.19,33965473,552212791,8393,16.17,127400,16.16,37129,16.15,5400,16.14,17700,16.13,1100,16.19,54504,16.20,400,16.21,14200,16.22,10400,16.23,2015-09-08,13:01:46,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.20,16.40,16.05,16.20,16.21,34021077,553113565,9796,16.20,500,16.18,8393,16.17,127400,16.16,37129,16.15,400,16.21,14200,16.22,10400,16.23,41600,16.24,33200,16.25,2015-09-08,13:01:51,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.24,16.40,16.05,16.22,16.24,34050577,553592076,6100,16.22,500,16.18,8393,16.17,127400,16.16,37129,16.15,40600,16.24,33200,16.25,46900,16.26,100,16.27,17000,16.28,2015-09-08,13:01:56,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.22,16.40,16.05,16.18,16.19,34056677,553691018,500,16.18,13593,16.17,127400,16.16,37129,16.15,5400,16.14,1200,16.19,7500,16.22,40600,16.24,33300,16.25,46900,16.26,2015-09-08,13:02:01,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.19,16.40,16.05,16.21,16.22,34059577,553737940,4300,16.21,12893,16.17,127400,16.16,37129,16.15,5400,16.14,7500,16.22,40600,16.24,33200,16.25,46900,16.26,100,16.27,2015-09-08,13:02:06,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.22,16.40,16.05,16.21,16.24,34071077,553924430,300,16.21,15393,16.17,127400,16.16,37129,16.15,5400,16.14,40600,16.24,33200,16.25,46900,16.26,100,16.27,17000,16.28,2015-09-08,13:02:11,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.24,16.40,16.05,16.18,16.22,34079977,554068927,21000,16.18,26393,16.17,120000,16.16,37129,16.15,5400,16.14,500,16.22,30000,16.23,33000,16.24,33300,16.25,46900,16.26,2015-09-08,13:02:16,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.24,16.40,16.05,16.21,16.22,34079977,554068927,8600,16.21,31000,16.18,26393,16.17,120000,16.16,37129,16.15,500,16.22,30100,16.23,33000,16.24,33300,16.25,46900,16.26,2015-09-08,13:02:21,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.23,16.40,16.05,16.18,16.23,34088277,554203611,31000,16.18,30193,16.17,120000,16.16,37129,16.15,5400,16.14,25300,16.23,33000,16.24,33300,16.25,46600,16.26,100,16.27,2015-09-08,13:02:26,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.24,16.40,16.05,16.22,16.24,34134277,554950338,5600,16.22,31000,16.18,30193,16.17,120000,16.16,37129,16.15,15300,16.24,33300,16.25,46600,16.26,100,16.27,17000,16.28,2015-09-08,13:02:31,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.25,16.40,16.05,16.24,16.25,34162046,555401347,5600,16.24,31,16.21,31000,16.18,30193,16.17,120000,16.16,23300,16.25,46600,16.26,100,16.27,17000,16.28,24918,16.29,2015-09-08,13:02:36,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.25,16.40,16.05,16.18,16.24,34175846,555625326,29331,16.18,30393,16.17,120000,16.16,37129,16.15,5400,16.14,2900,16.24,30000,16.25,46700,16.26,100,16.27,17000,16.28,2015-09-08,13:02:41,00\";");
            strList.Add("var hq_str_sh600036=\"招商银行,16.16,16.16,16.18,16.40,16.05,16.18,16.22,34177306,555648979,28371,16.18,30393,16.17,119700,16.16,37129,16.15,5400,16.14,500,16.22,8100,16.23,2400,16.24,30000,16.25,46700,16.26,2015-09-08,13:02:46,00\";");

            return strList;
        }
    }

    internal class SinaRealTimeData : RealTimeData
    {
        public SinaRealTimeData(string strData)
        {
            strData = strData.Remove(0, 11);
            this.Code = strData.Substring(0, 8);

            int startIndex = strData.IndexOf("\"") + 1;
            int length = strData.LastIndexOf("\"") - startIndex;
            strData = strData.Substring(startIndex, length);

            string[] fields = strData.Split(',');

            this.Name = fields[0];
            this.TodayOpen = Convert.ToDouble(fields[1]);
            this.YesterdayClose = Convert.ToDouble(fields[2]);
            this.Price = Convert.ToDouble(fields[3]);
            this.High = Convert.ToDouble(fields[4]);
            this.Low = Convert.ToDouble(fields[5]);
            this.Volume = Convert.ToDouble(fields[8]);
            this.Amount = Convert.ToDouble(fields[9]);

            this.BuyOneVolume = Convert.ToDouble(fields[10]);
            this.BuyOnePrice = Convert.ToDouble(fields[11]);

            this.BuyTwoVolume = Convert.ToDouble(fields[12]);
            this.BuyTwoPrice = Convert.ToDouble(fields[13]);

            this.BuyThreeVolume = Convert.ToDouble(fields[14]);
            this.BuyThreePrice = Convert.ToDouble(fields[15]);

            this.BuyFourVolume = Convert.ToDouble(fields[16]);
            this.BuyFourPrice = Convert.ToDouble(fields[17]);

            this.BuyFiveVolume = Convert.ToDouble(fields[18]);
            this.BuyFivePrice = Convert.ToDouble(fields[19]);

            this.SellOneVolume = Convert.ToDouble(fields[20]);
            this.SellOnePrice = Convert.ToDouble(fields[21]);

            this.SellTwoVolume = Convert.ToDouble(fields[22]);
            this.SellTwoPrice = Convert.ToDouble(fields[23]);

            this.SellThreeVolume = Convert.ToDouble(fields[24]);
            this.SellThreePrice = Convert.ToDouble(fields[25]);

            this.SellFourVolume = Convert.ToDouble(fields[26]);
            this.SellFourPrice = Convert.ToDouble(fields[27]);

            this.SellFiveVolume = Convert.ToDouble(fields[28]);
            this.SellFivePrice = Convert.ToDouble(fields[29]);

            this.Time = Convert.ToDateTime(fields[30] + " " + fields[31]);
        }

        public override string ToString()
        {
            if (!string.IsNullOrWhiteSpace(this.Code) &&
                !string.IsNullOrWhiteSpace(this.Name))
            {
                return this.Code + " " + this.Name + " " + this.Price;
            }
            else
            {
                return base.ToString();
            }
        }
    }
}
